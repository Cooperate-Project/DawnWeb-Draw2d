<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Draw2d - Label View 4 testing</title>

    <script src="bower_components/jquery/jquery.min.js"></script>
    <script src="bower_components/draw2d/dist/pathfinding-browser.min.js"></script>
    <script src="bower_components/draw2d/dist/json2.js"></script>
    <script src="bower_components/draw2d/dist/patched_Class.js"></script>
    <script src="bower_components/draw2d/dist/patched_canvg.js"></script>
    <script src="bower_components/draw2d/dist/rgbcolor.js"></script>
    <script src="bower_components/draw2d/dist/jquery.contextmenu.js"></script>
    <script src="bower_components/draw2d/dist/jquery-touch_punch.js"></script>
    <script src="bower_components/draw2d/dist/jquery.autoresize.js"></script>
    <script src="bower_components/draw2d/dist/patched_raphael.js"></script>
    <script src="bower_components/shifty/dist/shifty.min.js"></script>
    <script src="bower_components/draw2d/dist/draw2d.js"></script>

    <script src="../../../../DawnWeb/bundles/de.cooperateproject.cdo.dawn.frontend.lib/web_content/lib/swagger-client.js"></script>
    <script src="../../../../DawnWeb/bundles/de.cooperateproject.cdo.dawn.frontend.lib/web_content/api/dawnweb.js"></script>
    <script src="../../../../DawnWeb/bundles/de.cooperateproject.cdo.dawn.frontend.lib/web_content/api/consts.js"></script>

    <script type="text/javascript">
        DawnWeb.init();
    </script>
</head>
<body>
<div id="gfx_holder"
     style="width: 1500px; height: 1500px; cursor: default; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
</div>
<script type="text/javascript">
    $.urlParam = function (name) {
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results == null) {
            return null;
        }
        else {
            return decodeURI(results[1]) || 0;
        }
    };

    $.reduce = function (obj1, obj2) {
        for (var k in obj2) {
            if (obj1.hasOwnProperty(k) && obj2.hasOwnProperty(k)) {
                if (typeof obj1[k] == "object" && typeof obj2[k == "object"]) {
                    $.reduce(obj1[k], obj2[k]);
                } else {
                    delete obj1[k];
                }
            }
        }
    };

    var project = $.urlParam('project');
    var model = $.urlParam('model');

    var canvas = new draw2d.Canvas("gfx_holder");

    var jsonPrototype = {
        "type": "draw2d.shape.basic.Label",
        "alpha": 1,
        "angle": 0,
        "userData": {},
        "cssClass": "draw2d_shape_basic_Label",
        "ports": [],
        "bgColor": "none",
        "color": "#1B1B1B",
        "stroke": 1,
        "radius": 0,
        "dasharray": null,
        "outlineStroke": 0,
        "outlineColor": "none",
        "fontSize": 12,
        "fontColor": "#080808",
        "fontFamily": null,
        "editor": "draw2d.ui.LabelInplaceEditor"
    };

    // Get data from server
    DawnWeb.getClient().then(function (server) {
        return server.apis.draw2d.getClassesAsLabels({projectId: project, modelId: model});
    })
        .then(function (result) {

            var jsonData = result.obj;

            $.each(jsonData, function (i, elem) {
                $.extend(elem, jsonPrototype);
            });

            var reader = new draw2d.io.json.Reader();
            reader.unmarshal(canvas, jsonData);

            canvas.getCommandStack().addEventListener(function (e) {
                if (e.isPostChangeEvent()) {
                    console.log("CHANGE!");
                    var writer = new draw2d.io.json.Writer();
                    writer.marshal(canvas, function (json) {

                        $.each(json, function (i, elem) {
                            $.reduce(elem, jsonPrototype);
                        });

                        console.log(json);

                        DawnWeb.getClient().then(function (server) {
                           return server.apis.draw2d.setLabelsAsClasses({projectId: project, modelId: model, labels: JSON.stringify(json)});
                        })
                            .then(function (result) {
                                console.log("Update answer:" + result);
                        });

                    });
                }
            });


        });


</script>
</body>
</html>