<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Draw2d - Label View 4 testing</title>

    <script src="../bower_components/jquery/jquery.min.js"></script>
    <script src="../bower_components/draw2d/dist/pathfinding-browser.min.js"></script>
    <script src="../bower_components/draw2d/dist/json2.js"></script>
    <script src="../bower_components/draw2d/dist/patched_Class.js"></script>
    <script src="../bower_components/draw2d/dist/patched_canvg.js"></script>
    <script src="../bower_components/draw2d/dist/rgbcolor.js"></script>
    <script src="../bower_components/draw2d/dist/jquery.contextmenu.js"></script>
    <script src="../bower_components/draw2d/dist/jquery-touch_punch.js"></script>
    <script src="../bower_components/draw2d/dist/jquery.autoresize.js"></script>
    <script src="../bower_components/draw2d/dist/patched_raphael.js"></script>
    <script src="../bower_components/shifty/dist/shifty.min.js"></script>
    <script src="../bower_components/draw2d/dist/draw2d.js"></script>

    <script src="../../../../../DawnWeb/bundles/de.cooperateproject.cdo.dawn.frontend.lib/web_content/lib/swagger-client.js"></script>
    <script src="../../../../../DawnWeb/bundles/de.cooperateproject.cdo.dawn.frontend.lib/web_content/api/dawnweb.js"></script>
    <script src="../../../../../DawnWeb/bundles/de.cooperateproject.cdo.dawn.frontend.lib/web_content/api/consts.js"></script>

    <script src="../shapes/testShape.js"></script>
    <script src="../shapes/TableShape.js"></script>
    <script src="../shapes/LegacyClassShape.js"></script>

    <script src="../shapes/ListCompartment.js"></script>
    <script src="../shapes/AttributeCompartment.js"></script>
    <script src="../shapes/OperationCompartment.js"></script>
    <script src="../shapes/ClassShape.js"></script>
    <script src="../shapes/RichConnection.js"></script>
    <script src="../shapes/SimpleArrowDecorator.js"></script>
    <script src="../shapes/PackageShape.js"></script>

    <script type="text/javascript">
        //DawnWeb.init();
    </script>

    <link rel="stylesheet" href="../css/contextmenu.css">

</head>
<body>
<div id="button">
    <button onclick="writeJSON()">Write JSON</button>
    <button onclick="readJSON()">Read JSON</button>
</div>
<div id="gfx_holder"
     style="width: 1500px; height: 1500px; cursor: default; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
</div>
<script type="text/javascript">

    var docJson = "";

    function writeJSON() {
        console.log("Writing JSON...");

        // Insert parent information (for z order)
        setParentInformation();

        // Write JSON
        var writer = new draw2d.io.json.Writer();
        writer.marshal(canvas, function (json) {

            console.log(json);
            docJson = json;
        });

        canvas.clear();
    }

    function readJSON() {
        console.log("Reading JSON...");

        // Read JSON
        var reader = new draw2d.io.json.Reader();
        reader.unmarshal(canvas, docJson);

        // Fix z order
        $.each(docJson, function (i, o) {
            moveParentsBack(canvas.getFigure(o.id));
        })

    }

    function moveParentsBack(figure) {
        figure.toBack();

        if (figure.parentFigure != null) {
            moveParentsBack(canvas.getFigure(figure.parentFigure));
        }
    }

    function setParentInformation() {
        var figures = canvas.getFigures().data;
        $.each(figures, function (i, p) {
            if (p.NAME == "PackageShape") {
                $.each(p.getAboardFigures(true).data, function (i, o) {
                        canvas.getFigure(o.getId()).parentFigure = p.getId();
                    }
                );
            }
        })
        ;
    }

    $.urlParam = function (name) {
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results == null) {
            return null;
        }
        else {
            return decodeURI(results[1]) || 0;
        }
    };

    $.reduce = function (obj1, obj2) {
        for (var k in obj2) {
            if (obj1.hasOwnProperty(k) && obj2.hasOwnProperty(k)) {
                if (typeof obj1[k] == "object" && typeof obj2[k == "object"]) {
                    $.reduce(obj1[k], obj2[k]);
                } else {
                    delete obj1[k];
                }
            }
        }
    };

    var project = $.urlParam('project');
    var model = $.urlParam('model');

    var canvas = new draw2d.Canvas("gfx_holder");

    canvas.installEditPolicy(new draw2d.policy.canvas.SnapToCenterEditPolicy);
    canvas.installEditPolicy(new draw2d.policy.canvas.SnapToGeometryEditPolicy);
    canvas.installEditPolicy(new draw2d.policy.canvas.SnapToInBetweenEditPolicy);

    canvas.installEditPolicy(new draw2d.policy.canvas.FadeoutDecorationPolicy());
    canvas.installEditPolicy(new draw2d.policy.connection.DragConnectionCreatePolicy({
        createConnection: function () {
            return new RichConnection();
        }
    }));

    // Package A
    var pgA = new PackageShape({
        x: 600,
        y: 600
    });
    pgA.setName("Package A");
    canvas.add(pgA);

    // Package B
    var pgB = new PackageShape({
        x: 300,
        y: 600
    });
    pgB.setName("Package B");
    canvas.add(pgB);

    // Class A
    var class1 = new ClassShape({
        x: 650, y: 650
    });
    class1.setName("Class A");
    class1.getAttributes().addAttribute("someProp");
    class1.getAttributes().addAttribute("someOtherProp");
    class1.getOperations().addOperation("doThis()");
    class1.getOperations().addOperation("doThat()");
    canvas.add(class1);

    // Class B
    var class2 = new ClassShape({
        x: 100, y: 100
    });
    class2.setName("Class B");
    class2.getAttributes().addAttribute("someOhterOhterProp");
    canvas.add(class2);

</script>
</body>
</html>